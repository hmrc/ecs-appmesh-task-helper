
# ecs-appmesh-task-helper

## What this is

The repo is to define a small event driven python app that orchestrates the lifecycle stages of an AWS ECS task in an AppMesh environment.
The stages we are interested in are startup and shutdown.

### Shutdown

When a task in an AppMesh mesh has been asked to ECS to stop, it needs to notify its downstreams that it is stopping so that the downstreams stop sending traffic before the task stops. This is to ensure the downstreams do not receive any 5xx or timeout errors, which could impact service performance.
This is done by signalling the Envoy in the task to go into healthcheck fail mode. The Envoy admin api has an endpoint which controls this.
Secondly, this task helper is designed to delay the termination of the application and envoy containers in the task in order to ensure the downstream envoys have completed their upstream health check cycle.
When ECS terminates a task, it executes "docker stop" against each container in the task in the reverse order of the defined dependencies in the task. "docker stop" sends a SIGTERM signal to the process inside the container when it runs. This task helper pauses for a definable time period after the SIGTERM. When the task helper DependsOn the envoy and application containers, their termination is delayed.

## How to use this

A container image containing the application can be generated by running "make build" in the project folder. This uses docker with python:slim and python:alpine source images. The container image should then be included in the container definitions for your ECS task, with DependsOn dependencies defined to your application and envoy containers.


# License

This code is open source software licensed under the [Apache 2.0 License]("http://www.apache.org/licenses/LICENSE-2.0.html").
