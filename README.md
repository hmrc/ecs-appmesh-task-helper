# ecs-appmesh-task-helper

## What this is

The repo is to define a small event-driven python app that orchestrates the lifecycle stages of an AWS ECS task in an AppMesh environment.

The stages we are interested in are startup and shutdown.

In an ECS service with a load balancer attached, during a task definition update, ECS ensures that the new tasks started are registered with the LB and in service before it continues to drain and stop the old tasks. This native helper does not exist for AppMesh, so this task helper has been written to bridge that gap.

### Operation

When a task in an AppMesh mesh has been asked by ECS to stop, it needs to notify its downstreams that it is stopping, so that the downstreams stop sending traffic before the task stops. This is to ensure the downstreams do not receive any 5xx or timeout errors, which could impact service performance.

Notifying the downstreams that the task needs draining is done by signalling the Envoy in the task to go into health check fail mode. The Envoy admin API has an endpoint (`/healthcheck/fail` and `healthcheck/ok`) which controls the behaviour of inbound health checks (via the health check filter).

Secondly, this task helper is designed to delay the termination of the application and envoy containers in the task to ensure the downstream Envoys have completed their upstream health check cycle.

Thirdly, the task helper is designed to delay termination of a task before its replacement is in service - due to a race condition that often sees retiring tasks stopped before new tasks are in service during a task definition update. There is a delay period encoded before the health check is put in fail mode to ensure that new tasks have plenty of time to become in service before retiring tasks are drained and stopped. This ensures an overlap between the new and retiring tasks so that updates can be non-disruptive.

Tasks that include this helper MUST ensure the task helper container `DependsOn` the application container(s). For MDTP microservices, this means the task helper `DependsOn` the envoy and application containers.

When ECS terminates a microservice task, it:
1. Executes "docker stop" against the task helper container
1. "docker stop" sends a SIGTERM signal to the process inside the task helper container
1. This task helper intercepts the SIGTERM, then
   1. Waits for DRAIN_DELAY seconds, to give new tasks time to become healthy
   1. Call the task envoys admin API to put it in health check fail mode
   1. Waits for DRAIN_TIMEOUT seconds, to give the terminating task time to drain
1. Executes "docker stop" against the envoy and application containers

## How to use this

A container image containing the application can be generated by running "make build" in the project folder. This uses docker with python:slim and python:alpine source images.

The container image should then be included in the container definitions for your ECS task, with `DependsOn` dependencies to your application and envoy containers defined.

The task helper container should set a `stopTimeout` to the sum of the drain delay, drain timeout and an arbitrary 10 seconds for the task helper to do its work during the container shutdown. With the default settings, the `stopTimeout` should be 130s.

There are 2 environment variables that can be optionally passed to the container to adjust its operation.

* DRAIN_DELAY: The time period to wait after the SIGTERM but before calling the `healthcheck/fail` admin endpoint. Defaults to 40
* DRAIN_TIMEOUT: The time period to wait after calling the `healthcheck/fail` admin endpoint. Defaults to 80

# License

This code is open source software licensed under
the [Apache 2.0 License]("http://www.apache.org/licenses/LICENSE-2.0.html").
